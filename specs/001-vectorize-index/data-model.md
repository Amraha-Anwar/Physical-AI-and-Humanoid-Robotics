# P2.2 Vectorization & Indexing: OpenAI Embeddings and Dual-DB Ingestion - Data Model

This document outlines the data flow and conceptual models involved in the vectorization and dual-database ingestion process. It builds upon the `RagChunk` model from P1.3 and uses it as the central data structure.

## 1. Input Data Model

**Entity**: `Input JSON File`

**Description**: A file containing a list of `RagChunk` objects, produced by the P2.1 content pre-processing script. This serves as the primary input for the vectorization and indexing script.

**Key Characteristics**:
*   Format: JSON array of objects.
*   Each object conforms to the `RagChunk` Pydantic model schema.
*   Location: Specified input file path.

## 2. Core Data Model

**Entity**: `RagChunk Object`

**Description**: The central data structure representing a processed text chunk with its metadata. This Pydantic model is defined in `backend/models.py`.

**Attributes (as per `backend/models.py.RagChunk`)**:
*   `chunk_id` (str): Unique identifier for the text chunk (e.g., UUID).
*   `document_id` (str): Identifier for the source MDX document.
*   `chapter_title` (str): Title of the chapter/document.
*   `page_number` (int): Page number or logical sequence number for the chunk.
*   `text_snippet_preview` (str): The actual text content of the chunk.
*   `created_at` (datetime, optional): Timestamp of creation.

## 3. Transformed Data Models

### 3.1 Vector Embedding

**Entity**: `Vector Embedding`

**Description**: A high-dimensional numerical representation of a `RagChunk`'s `text_snippet_preview`, generated by the OpenAI Embeddings API.

**Key Characteristics**:
*   Dimension: 1536 (for `text-embedding-ada-002` or compatible OpenAI models).
*   Type: List of floats.

### 3.2 Qdrant PointStruct

**Entity**: `Qdrant PointStruct`

**Description**: The data structure used to store a `Vector Embedding` and its associated `chunk_id` and other relevant metadata in Qdrant.

**Key Attributes**:
*   `id` (str): Corresponds to `RagChunk.chunk_id`.
*   `vector` (List[float]): The `Vector Embedding`.
*   `payload` (dict): A dictionary containing metadata from the `RagChunk` (e.g., `chapter_title`, `text_snippet_preview`).

**Relationship**: One `RagChunk Object` maps to one `Qdrant PointStruct`.

### 3.3 Neon Postgres Row

**Entity**: `Neon Postgres Row`

**Description**: A record in the `rag_metadata` table within Neon Postgres, storing the textual and structural metadata of a `RagChunk`.

**Key Attributes**:
*   `chunk_id` (str): Corresponds to `RagChunk.chunk_id`.
*   `document_id` (str)
*   `chapter_title` (str)
*   `page_number` (int)
*   `text_snippet_preview` (str)
*   `created_at` (datetime)

**Relationship**: One `RagChunk Object` maps to one `Neon Postgres Row`.

## 4. Data Flow

1.  **Read Input**: The script reads the `Input JSON File` into a list of `RagChunk Objects`.
2.  **Batch Processing**: `RagChunk Objects` are grouped into batches.
3.  **Vectorization**: For each batch, `text_snippet_preview` fields are sent to the `OpenAI Embeddings API` to obtain `Vector Embeddings`.
4.  **Dual Ingestion**:
    *   `Vector Embeddings` and relevant `chunk_id`/`payload` are formatted into `Qdrant PointStruct` and sent to Qdrant.
    *   `RagChunk Object` metadata is formatted into `Neon Postgres Rows` and inserted into Neon Postgres.
5.  **Verification**: Counts are checked to ensure data integrity across both databases.
